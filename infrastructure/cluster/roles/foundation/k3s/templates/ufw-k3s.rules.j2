#!/bin/bash
# UFW rules for K3s cluster - Generated by Ansible

# Reset UFW to defaults
ufw --force reset
ufw default deny incoming
ufw default allow outgoing

# Allow SSH
ufw allow 22/tcp

{% for host in groups['all'] %}
{% if hostvars[host]['ansible_default_ipv4']['address'] != ansible_default_ipv4.address %}
# Allow from {{ host }} ({{ hostvars[host]['ansible_default_ipv4']['address'] }})
ufw allow from {{ hostvars[host]['ansible_default_ipv4']['address'] }} to any port 6443 proto tcp
ufw allow from {{ hostvars[host]['ansible_default_ipv4']['address'] }} to any port 10250 proto tcp  
ufw allow from {{ hostvars[host]['ansible_default_ipv4']['address'] }} to any port 179 proto tcp
ufw allow from {{ hostvars[host]['ansible_default_ipv4']['address'] }} to any port 4789 proto udp
ufw allow from {{ hostvars[host]['ansible_default_ipv4']['address'] }} to any port 5473 proto tcp
ufw allow from {{ hostvars[host]['ansible_default_ipv4']['address'] }} to any port 9100 proto tcp
{% endif %}
{% endfor %}

# NodePort range for external access
ufw allow 30000:32767/tcp

# Pod and service networks (Calico)
ufw allow from 10.244.0.0/16
ufw allow from 10.96.0.0/12

# Enable UFW
ufw --force enable

echo "UFW configured for K3s cluster"